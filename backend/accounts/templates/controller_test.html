<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controller Test Panel</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f172a; color: #e2e8f0; padding: 24px; }
    h1 { font-size: 22px; margin-bottom: 20px; color: #38bdf8; }
    h2 { font-size: 16px; margin-bottom: 12px; color: #94a3b8; }
    .card { background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 20px; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px; font-weight: 500; }
    input, select { width: 100%; padding: 8px 10px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; font-size: 13px; }
    input:focus, select:focus { outline: none; border-color: #38bdf8; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: .15s; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .actions { display: flex; gap: 8px; margin-top: 16px; align-items: center; }
    .status { font-size: 12px; padding: 4px 10px; border-radius: 4px; }
    .status-ok { background: #064e3b; color: #34d399; }
    .status-err { background: #450a0a; color: #fca5a5; }
    .status-info { background: #172554; color: #93c5fd; }
    #log { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 12px; margin-top: 16px; max-height: 200px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.6; }
    .log-entry { padding: 2px 0; border-bottom: 1px solid #1e293b; }
    .log-time { color: #64748b; }
    .log-ok { color: #34d399; }
    .log-err { color: #fca5a5; }
    .ctrl-select { display: flex; gap: 8px; align-items: end; margin-bottom: 16px; }
    .ctrl-select > div:first-child { flex: 1; }
    .current-values { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
    .cv-box { background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 8px 10px; }
    .cv-label { font-size: 10px; color: #64748b; text-transform: uppercase; }
    .cv-value { font-size: 14px; font-weight: 600; color: #f1f5f9; margin-top: 2px; }
  </style>
</head>
<body>

  <h1>&#9881; Controller Test Panel</h1>

  <!-- Login -->
  <div class="card" id="login-card">
    <h2>Login (admin credentials)</h2>
    <div style="display:flex; gap:12px; align-items:end;">
      <div><label>Username</label><input id="username" value="admin"></div>
      <div><label>Password</label><input id="password" type="password" value="admin"></div>
      <button class="btn btn-primary" onclick="doLogin()">Login</button>
      <span id="login-status"></span>
    </div>
  </div>

  <!-- Controller selector + form -->
  <div class="card" id="main-card" style="display:none;">
    <div class="ctrl-select">
      <div>
        <label>Select Controller</label>
        <select id="ctrl-select" onchange="onSelectCtrl()">
          <option value="">-- Choose --</option>
        </select>
      </div>
      <button class="btn btn-sm btn-primary" onclick="loadControllers()">Refresh List</button>
    </div>

    <!-- Current values display -->
    <div id="current-section" style="display:none;">
      <h2>Current Values</h2>
      <div class="current-values" id="current-values"></div>

      <h2>Update Metrics</h2>
      <div class="grid">
        <div><label>CPU Usage</label><input id="f-cpu_usage" placeholder="e.g. 45%"></div>
        <div><label>RAM Usage</label><input id="f-ram_usage" placeholder="e.g. 60%"></div>
        <div><label>CPU Temperature</label><input id="f-cpu_temperature" placeholder="e.g. 55 C"></div>
        <div><label>Storage Usage</label><input id="f-storage_usage" placeholder="e.g. 30 GB / 100 GB"></div>
        <div><label>System Uptime</label><input id="f-system_uptime" placeholder="e.g. 5d 12h"></div>
        <div><label>Voltage / Power</label><input id="f-voltage_power_status" placeholder="e.g. Normal"></div>
      </div>

      <div class="actions">
        <button class="btn btn-success" onclick="pushMetrics()">Push Update</button>
        <button class="btn btn-sm btn-primary" onclick="fillRandom()">Fill Random</button>
        <button class="btn btn-sm btn-danger" onclick="clearFields()">Clear</button>
        <span id="push-status"></span>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div class="card">
    <h2>Activity Log</h2>
    <div id="log"><div style="color:#64748b;">No activity yet.</div></div>
  </div>

<script>
const API = 'http://localhost:8000/api/auth';
const METRICS = ['cpu_usage','ram_usage','cpu_temperature','storage_usage','system_uptime','voltage_power_status'];
const LABELS = { cpu_usage:'CPU Usage', ram_usage:'RAM Usage', cpu_temperature:'CPU Temp', storage_usage:'Storage', system_uptime:'Uptime', voltage_power_status:'Power' };
let csrfToken = '';
let controllers = [];
let selectedCtrl = null;

function getCookie(name) {
  const v = `; ${document.cookie}`;
  const p = v.split(`; ${name}=`);
  return p.length === 2 ? p.pop().split(';').shift() : '';
}

function log(msg, type = 'ok') {
  const el = document.getElementById('log');
  const t = new Date().toLocaleTimeString();
  el.innerHTML = `<div class="log-entry"><span class="log-time">[${t}]</span> <span class="log-${type}">${msg}</span></div>` + el.innerHTML;
}

function setStatus(id, text, type) {
  document.getElementById(id).innerHTML = `<span class="status status-${type}">${text}</span>`;
  setTimeout(() => document.getElementById(id).innerHTML = '', 3000);
}

async function doLogin() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  try {
    // Get CSRF
    await fetch(`${API}/me/`, { credentials: 'include' });
    csrfToken = getCookie('csrftoken');
    const res = await fetch(`${API}/login/`, {
      method: 'POST', credentials: 'include',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify({ username: user, password: pass })
    });
    if (!res.ok) throw new Error('Invalid credentials');
    csrfToken = getCookie('csrftoken');
    setStatus('login-status', 'Logged in!', 'ok');
    log('Logged in as ' + user);
    document.getElementById('main-card').style.display = 'block';
    loadControllers();
  } catch (e) {
    setStatus('login-status', e.message, 'err');
    log('Login failed: ' + e.message, 'err');
  }
}

async function loadControllers() {
  try {
    csrfToken = getCookie('csrftoken');
    const res = await fetch(`${API}/controllers/`, { credentials: 'include', headers: { 'X-CSRFToken': csrfToken } });
    controllers = await res.json();
    const sel = document.getElementById('ctrl-select');
    const prev = sel.value;
    sel.innerHTML = '<option value="">-- Choose --</option>';
    controllers.forEach(c => {
      sel.innerHTML += `<option value="${c.id}">${c.name} (${c.ip_address})</option>`;
    });
    if (prev) sel.value = prev;
    onSelectCtrl();
    log(`Loaded ${controllers.length} controller(s)`);
  } catch (e) {
    log('Failed to load controllers: ' + e.message, 'err');
  }
}

function onSelectCtrl() {
  const id = parseInt(document.getElementById('ctrl-select').value);
  selectedCtrl = controllers.find(c => c.id === id) || null;
  document.getElementById('current-section').style.display = selectedCtrl ? 'block' : 'none';
  if (selectedCtrl) {
    showCurrent(selectedCtrl);
    METRICS.forEach(k => document.getElementById('f-' + k).value = selectedCtrl[k] || '');
  }
}

function showCurrent(ctl) {
  const el = document.getElementById('current-values');
  el.innerHTML = METRICS.map(k =>
    `<div class="cv-box"><div class="cv-label">${LABELS[k]}</div><div class="cv-value">${ctl[k] || 'â€”'}</div></div>`
  ).join('');
}

async function pushMetrics() {
  if (!selectedCtrl) return;
  const payload = { name: selectedCtrl.name, ip_address: selectedCtrl.ip_address };
  METRICS.forEach(k => payload[k] = document.getElementById('f-' + k).value);
  try {
    csrfToken = getCookie('csrftoken');
    const res = await fetch(`${API}/controllers/${selectedCtrl.id}/`, {
      method: 'PUT', credentials: 'include',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error((await res.json()).error || 'Update failed');
    const updated = await res.json();
    selectedCtrl = updated;
    const idx = controllers.findIndex(c => c.id === updated.id);
    if (idx >= 0) controllers[idx] = updated;
    showCurrent(updated);
    setStatus('push-status', 'Updated!', 'ok');
    log(`Updated ${updated.name}: CPU=${updated.cpu_usage} RAM=${updated.ram_usage} Temp=${updated.cpu_temperature}`);
  } catch (e) {
    setStatus('push-status', e.message, 'err');
    log('Update failed: ' + e.message, 'err');
  }
}

function fillRandom() {
  document.getElementById('f-cpu_usage').value = Math.floor(Math.random() * 90 + 5) + '%';
  document.getElementById('f-ram_usage').value = Math.floor(Math.random() * 80 + 10) + '%';
  document.getElementById('f-cpu_temperature').value = Math.floor(Math.random() * 50 + 35) + ' C';
  const used = Math.floor(Math.random() * 75 + 5);
  const total = [100, 200, 500][Math.floor(Math.random() * 3)];
  document.getElementById('f-storage_usage').value = `${used} GB / ${total} GB`;
  document.getElementById('f-system_uptime').value = `${Math.floor(Math.random() * 30)}d ${Math.floor(Math.random() * 24)}h`;
  document.getElementById('f-voltage_power_status').value = ['Normal','Normal','Normal','Low','Critical'][Math.floor(Math.random() * 5)];
}

function clearFields() {
  METRICS.forEach(k => document.getElementById('f-' + k).value = '');
}
</script>
</body>
</html>
